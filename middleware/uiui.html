<script>
    // ========== CONFIGURATION ==========
    const getApiBaseUrl = () => {
        if (window.location.hostname === 'localhost' || 
            window.location.hostname === '127.0.0.1') {
            return 'http://localhost:3000/api';
        }
        // For Vercel deployment - use relative paths
        return '/api';
    };

    const API_BASE_URL = getApiBaseUrl();

    // ========== TRANSLATION SYSTEM ==========
    let currentLanguage = 'en';

    // Complete translation dictionary
    const translations = {
        en: {
            // Navigation
            "Home": "Home",
            "Search": "Search",
            "Post Job": "Post Job",
            "Jobs": "Jobs",
            "Employees": "Employees",
            "Profile": "Profile",
            
            // Home page
            "Karibu Kazi Mashinani": "Karibu Kazi Mashinani",
            "Empowering Rural Communities Through Employment Opportunities": "Empowering Rural Communities Through Employment Opportunities",
            "Job Opportunities Blog": "Job Opportunities Blog",
            "Agriculture Opportunities Growing in Rural Areas": "Agriculture Opportunities Growing in Rural Areas",
            "Discover the latest farming and agricultural job opportunities across rural Kenya. From seasonal farm work to permanent positions.": "Discover the latest farming and agricultural job opportunities across rural Kenya. From seasonal farm work to permanent positions.",
            "Read More": "Read More",
            "Construction Boom Creates New Jobs": "Construction Boom Creates New Jobs",
            "With infrastructure development accelerating, construction jobs are plentiful in rural towns and emerging urban centers.": "With infrastructure development accelerating, construction jobs are plentiful in rural towns and emerging urban centers.",
            "Domestic Work Opportunities": "Domestic Work Opportunities",
            "Reliable domestic helpers are in high demand. Learn about the requirements and benefits of domestic work positions.": "Reliable domestic helpers are in high demand. Learn about the requirements and benefits of domestic work positions.",
            "Let's Get Started": "Let's Get Started",
            "Find your next opportunity or post a job to find the perfect candidate": "Find your next opportunity or post a job to find the perfect candidate",
            "Search Jobs": "Search Jobs",
            "Browse through available job opportunities in your area. Filter by category, location, and more.": "Browse through available job opportunities in your area. Filter by category, location, and more.",
            "Find Jobs": "Find Jobs",
            "Post a Job": "Post a Job",
            "Have a job opening? Post it here to reach qualified candidates in your community.": "Have a job opening? Post it here to reach qualified candidates in your community.",
            "Post Job": "Post Job",
            "Find Employees": "Find Employees",
            "Browse through available workers in your area. Filter by skills, location, and more.": "Browse through available workers in your area. Filter by skills, location, and more.",
            
            // Search page
            "Find Jobs": "Find Jobs",
            "Search by job title, skills, or description...": "Search by job title, skills, or description...",
            "No jobs found matching your search.": "No jobs found matching your search.",
            "Found {count} jobs": "Found {count} jobs",
            
            // Post job page
            "Post a Job": "Post a Job",
            "Job Title *": "Job Title *",
            "e.g., Farm Manager, Construction Worker...": "e.g., Farm Manager, Construction Worker...",
            "Job Description *": "Job Description *",
            "Describe the job responsibilities and requirements...": "Describe the job responsibilities and requirements...",
            "Location *": "Location *",
            "Town, village, or area...": "Town, village, or area...",
            "Category": "Category",
            "General": "General",
            "Agriculture": "Agriculture",
            "Construction": "Construction",
            "Domestic Work": "Domestic Work",
            "Driving": "Driving",
            "Retail": "Retail",
            "Phone Number *": "Phone Number *",
            "e.g., 712345678": "e.g., 712345678",
            "Enter any format, we'll correct it automatically": "Enter any format, we'll correct it automatically",
            "WhatsApp (Optional)": "WhatsApp (Optional)",
            "Business Type (Optional)": "Business Type (Optional)",
            "e.g., Shop, Salon, Farm, Construction Company": "e.g., Shop, Salon, Farm, Construction Company",
            "Clear": "Clear",
            "Job posted successfully!": "Job posted successfully!",
            "Failed to post job. Please try again.": "Failed to post job. Please try again.",
            
            // Jobs page
            "Available Jobs": "Available Jobs",
            "Newest": "Newest",
            "By Location": "By Location",
            "By Category": "By Category",
            "No jobs found. Be the first to post a job!": "No jobs found. Be the first to post a job!",
            "Previous": "Previous",
            "Next": "Next",
            
            // Employees page
            "Available Employees": "Available Employees",
            "By Name": "By Name",
            "By Location": "By Location",
            "By Specialization": "By Specialization",
            "No employees found.": "No employees found.",
            "Found {count} employees": "Found {count} employees",
            
            // Profile page
            "Profile": "Profile",
            "Manage your jobs and view your activity": "Manage your jobs and view your activity",
            "Total Jobs Posted": "Total Jobs Posted",
            "Total Applicants": "Total Applicants",
            "Active Jobs": "Active Jobs",
            "My Posted Jobs": "My Posted Jobs",
            "You haven't posted any jobs yet. Post your first job": "You haven't posted any jobs yet. Post your first job",
            "applicants": "applicants",
            "Edit": "Edit",
            "Delete": "Delete",
            "Edit Profile": "Edit Profile",
            "Change Password": "Change Password",
            "Log Out": "Log Out",
            "Employee": "Employee",
            "Employer": "Employer",
            "Member since": "Member since",
            "Mobile Number": "Mobile Number",
            "Specialization": "Specialization",
            "Job Types": "Job Types",
            "Last Login": "Last Login",
            "Not specified": "Not specified",
            "Authentication Required": "Authentication Required",
            "Please sign in to view your profile and manage your jobs.": "Please sign in to view your profile and manage your jobs.",
            "Sign In / Sign Up": "Sign In / Sign Up",
            "Browse Jobs": "Browse Jobs",
            
            // Authentication
            "Join Kazi Mashinani": "Join Kazi Mashinani",
            "Looking for Work": "Looking for Work",
            "Find job opportunities in your area": "Find job opportunities in your area",
            "Join as Employee": "Join as Employee",
            "Hiring Workers": "Hiring Workers",
            "Post jobs and find qualified candidates": "Post jobs and find qualified candidates",
            "Join as Employer": "Join as Employer",
            "Already have an account?": "Already have an account?",
            "Sign In": "Sign In",
            "Full Name *": "Full Name *",
            "Business/Organization Name *": "Business/Organization Name *",
            "Mobile Number *": "Mobile Number *",
            "Location *": "Location *",
            "Area of Specialization (Optional)": "Area of Specialization (Optional)",
            "Type of Jobs (Optional)": "Type of Jobs (Optional)",
            "Password *": "Password *",
            "Confirm Password *": "Confirm Password *",
            "Create Account": "Create Account",
            "Back": "Back",
            "Don't have an account?": "Don't have an account?",
            "Sign Up": "Sign Up",
            "Account created successfully! Welcome to Kazi Mashinani": "Account created successfully! Welcome to Kazi Mashinani",
            "Please fill in all required fields": "Please fill in all required fields",
            "Password must be at least 6 characters": "Password must be at least 6 characters",
            "Passwords do not match": "Passwords do not match",
            "Please enter a valid Kenyan phone number": "Please enter a valid Kenyan phone number",
            "An account with this phone number already exists": "An account with this phone number already exists",
            "Please enter phone number and password": "Please enter phone number and password",
            "Account not found. Please sign up first.": "Account not found. Please sign up first.",
            "Invalid password": "Invalid password",
            "Welcome back!": "Welcome back!",
            "Profile updated successfully": "Profile updated successfully",
            "Current password is incorrect": "Current password is incorrect",
            "New password must be at least 6 characters": "New password must be at least 6 characters",
            "New passwords do not match": "New passwords do not match",
            "Password changed successfully": "Password changed successfully",
            "You have been signed out": "You have been signed out",
            "Sign In to Contact": "Sign In to Contact",
            
            // Edit job modal
            "Edit Job": "Edit Job",
            "Update Job": "Update Job",
            "Cancel": "Cancel",
            "Job updated successfully!": "Job updated successfully!",
            "Failed to update job": "Failed to update job",
            "Job deleted successfully!": "Job deleted successfully!",
            "Failed to delete job": "Failed to delete job",
            "Are you sure you want to delete this job?": "Are you sure you want to delete this job?",
            
            // Footer
            "Connecting Rural Workers with Local Opportunities": "Connecting Rural Workers with Local Opportunities",
            "All rights reserved.": "All rights reserved.",
            
            // Toast messages
            "Form cleared": "Form cleared",
            "Sorted by {criteria}": "Sorted by {criteria}",
            "Translating website...": "Translating website...",
            "Page translated to English": "Page translated to English",
            "Page translated to Kiswahili": "Page translated to Kiswahili",
            "Call": "Call",
            "Sign Up as": "Sign Up as"
        },
        sw: {
            // Navigation
            "Home": "Nyumbani",
            "Search": "Tafuta",
            "Post Job": "Tuma Kazi",
            "Jobs": "Kazi",
            "Employees": "Wafanyakazi",
            "Profile": "Wasifu",
            
            // Home page
            "Karibu Kazi Mashinani": "Karibu Kazi Mashinani",
            "Empowering Rural Communities Through Employment Opportunities": "Kuwawezesha Jamii za Vijijini Kupitia Fursa za Ajira",
            "Job Opportunities Blog": "Blogu ya Fursa za Kazi",
            "Agriculture Opportunities Growing in Rural Areas": "Fursa za Kilimo Zinakua Katika Maeneo ya Vijijini",
            "Discover the latest farming and agricultural job opportunities across rural Kenya. From seasonal farm work to permanent positions.": "Gundua fursa mpya za kazi za kilimo na ukulima kote Kenya vijijini. Kutoka kazi za msimu hadi nafasi za kudumu.",
            "Read More": "Soma Zaidi",
            "Construction Boom Creates New Jobs": "Ukuaji wa Ujenzi Unazalisha Kazi Mpya",
            "With infrastructure development accelerating, construction jobs are plentiful in rural towns and emerging urban centers.": "Kwa kuongezeka kwa maendeleo ya miundombinu, kazi za ujenzi zimejaa katika mijijini na vituo vya mijini vinavyokua.",
            "Domestic Work Opportunities": "Fursa za Kazi za Nyumbani",
            "Reliable domestic helpers are in high demand. Learn about the requirements and benefits of domestic work positions.": "Wasaidizi wa nyumbani wa kuaminika wanaombwa sana. Jifunze kuhusu mahitaji na faida za nafasi za kazi za nyumbani.",
            "Let's Get Started": "Tuanze",
            "Find your next opportunity or post a job to find the perfect candidate": "Tafuta fursa yako ijayo au tuma kazi ili kupata mwombaji kamili",
            "Search Jobs": "Tafuta Kazi",
            "Browse through available job opportunities in your area. Filter by category, location, and more.": "Vinjari fursa za kazi zilizopo katika eneo lako. Chuja kwa kategoria, eneo, na zaidi.",
            "Find Jobs": "Tafuta Kazi",
            "Post a Job": "Tuma Kazi",
            "Have a job opening? Post it here to reach qualified candidates in your community.": "Una nafasi ya kazi? Itume hapa kufikia waombaji wenye sifa katika jamii yako.",
            "Post Job": "Tuma Kazi",
            "Find Employees": "Tafuta Wafanyakazi",
            "Browse through available workers in your area. Filter by skills, location, and more.": "Vinjari wafanyakazi walio katika eneo lako. Chuja kwa ujuzi, eneo, na zaidi.",
            
            // Search page
            "Find Jobs": "Tafuta Kazi",
            "Search by job title, skills, or description...": "Tafuta kwa kichwa cha kazi, ujuzi, au maelezo...",
            "No jobs found matching your search.": "Hakuna kazi zilizopatikana zinazolingana na utafutaji wako.",
            "Found {count} jobs": "Imepatikana kazi {count}",
            
            // Post job page
            "Post a Job": "Tuma Kazi",
            "Job Title *": "Kichwa cha Kazi *",
            "e.g., Farm Manager, Construction Worker...": "mf., Meneja wa Shamba, Mfanyakazi wa Ujenzi...",
            "Job Description *": "Maelezo ya Kazi *",
            "Describe the job responsibilities and requirements...": "Eleza majukumu na mahitaji ya kazi...",
            "Location *": "Eneo *",
            "Town, village, or area...": "Mji, kijiji, au eneo...",
            "Category": "Aina",
            "General": "Jumla",
            "Agriculture": "Kilimo",
            "Construction": "Ujenzi",
            "Domestic Work": "Kazi za Nyumbani",
            "Driving": "Kuendesha",
            "Retail": "Rejareja",
            "Phone Number *": "Nambari ya Simu *",
            "e.g., 712345678": "mf., 712345678",
            "Enter any format, we'll correct it automatically": "Weka muundo wowote, tutarekebisha kiotomatiki",
            "WhatsApp (Optional)": "WhatsApp (Hiari)",
            "Business Type (Optional)": "Aina ya Biashara (Hiari)",
            "e.g., Shop, Salon, Farm, Construction Company": "mf., Duka, Salon, Shamba, Kampuni ya Ujenzi",
            "Clear": "Futa",
            "Job posted successfully!": "Kazi imetumwa kikamirifu!",
            "Failed to post job. Please try again.": "Imeshindwa kutuma kazi. Tafadhali jaribu tena.",
            
            // Jobs page
            "Available Jobs": "Kazi Zilizopo",
            "Newest": "Mpya Zaidi",
            "By Location": "Kwa Eneo",
            "By Category": "Kwa Aina",
            "No jobs found. Be the first to post a job!": "Hakuna kazi zilizopatikana. Wawe wa kwanza kutuma kazi!",
            "Previous": "Iliyopita",
            "Next": "Ijayo",
            
            // Employees page
            "Available Employees": "Wafanyakazi Walio Hapo",
            "By Name": "Kwa Jina",
            "By Location": "Kwa Eneo",
            "By Specialization": "Kwa Utaalamu",
            "No employees found.": "Hakuna wafanyakazi walio patikana.",
            "Found {count} employees": "Wamepatikana wafanyakazi {count}",
            
            // Profile page
            "Profile": "Wasifu",
            "Manage your jobs and view your activity": "Dhibiti kazi zako na tazama shughuli zako",
            "Total Jobs Posted": "Jumla ya Kazi Zilizotumwa",
            "Total Applicants": "Jumla ya Waombaji",
            "Active Jobs": "Kazi Zilizo Hai",
            "My Posted Jobs": "Kazi Zangu Zilizotumwa",
            "You haven't posted any jobs yet. Post your first job": "Hujatumi kazi yoyote bado. Tuma kazi yako ya kwanza",
            "applicants": "waombaji",
            "Edit": "Hariri",
            "Delete": "Futa",
            "Edit Profile": "Hariri Wasifu",
            "Change Password": "Badilisha Nywila",
            "Log Out": "Toka",
            "Employee": "Mfanyakazi",
            "Employer": "Mwajiri",
            "Member since": "Mwanachama tangu",
            "Mobile Number": "Nambari ya Simu",
            "Specialization": "Utaalamu",
            "Job Types": "Aina za Kazi",
            "Last Login": "Mwingilio wa Mwisho",
            "Not specified": "Haijabainishwa",
            "Authentication Required": "Uthibitishaji Unahitajika",
            "Please sign in to view your profile and manage your jobs.": "Tafadhali ingia ili kuona wasifu wako na kudhibiti kazi zako.",
            "Sign In / Sign Up": "Ingia / Jisajili",
            "Browse Jobs": "Vinjari Kazi",
            
            // Authentication
            "Join Kazi Mashinani": "Jiunge na Kazi Mashinani",
            "Looking for Work": "Kutafuta Kazi",
            "Find job opportunities in your area": "Pata fursa za kazi katika eneo lako",
            "Join as Employee": "Jiunge kama Mfanyakazi",
            "Hiring Workers": "Kuajiri Wafanyakazi",
            "Post jobs and find qualified candidates": "Tuma kazi na upate waombaji wenye sifa",
            "Join as Employer": "Jiunge kama Mwajiri",
            "Already have an account?": "Tayari una akaunti?",
            "Sign In": "Ingia",
            "Full Name *": "Jina Kamili *",
            "Business/Organization Name *": "Jina la Biashara/Shirika *",
            "Mobile Number *": "Nambari ya Simu *",
            "Location *": "Eneo *",
            "Area of Specialization (Optional)": "Eneo la Utaalamu (Hiari)",
            "Type of Jobs (Optional)": "Aina ya Kazi (Hiari)",
            "Password *": "Nywila *",
            "Confirm Password *": "Thibitisha Nywila *",
            "Create Account": "Undi Akaunti",
            "Back": "Rudi",
            "Don't have an account?": "Huna akaunti?",
            "Sign Up": "Jisajili",
            "Account created successfully! Welcome to Kazi Mashinani": "Akaunti imeundwa kikamilifu! Karibu Kazi Mashinani",
            "Please fill in all required fields": "Tafadhali jaza sehemu zote zinazohitajika",
            "Password must be at least 6 characters": "Nywila lazima iwe na herufi angalau 6",
            "Passwords do not match": "Nywila hazifanani",
            "Please enter a valid Kenyan phone number": "Tafadhali weka nambari halali ya simu ya Kenya",
            "An account with this phone number already exists": "Tayari kuna akaunti iliyo na nambari hii ya simu",
            "Please enter phone number and password": "Tafadhali weka nambari ya simu na nywila",
            "Account not found. Please sign up first.": "Akaunti haijapatikana. Tafadhali jisajili kwanza.",
            "Invalid password": "Nywila batili",
            "Welcome back!": "Karibu tena!",
            "Profile updated successfully": "Wasifu umesasishwa kikamilifu",
            "Current password is incorrect": "Nywila ya sasa si sahihi",
            "New password must be at least 6 characters": "Nywila mpya lazima iwe na herufi angalau 6",
            "New passwords do not match": "Nywila mpya hazifanani",
            "Password changed successfully": "Nywila imebadilishwa kikamilifu",
            "You have been signed out": "Umetoka kwenye mfumo",
            "Sign In to Contact": "Ingia Ili Wasiliana",
            
            // Edit job modal
            "Edit Job": "Hariri Kazi",
            "Update Job": "Sasisha Kazi",
            "Cancel": "Ghairi",
            "Job updated successfully!": "Kazi imesasishwa kikamilifu!",
            "Failed to update job": "Imeshindwa kusasisha kazi",
            "Job deleted successfully!": "Kazi imefutwa kikamilifu!",
            "Failed to delete job": "Imeshindwa kufuta kazi",
            "Are you sure you want to delete this job?": "Una uhakika unataka kufuta kazi hii?",
            
            // Footer
            "Connecting Rural Workers with Local Opportunities": "Kuunganisha Wafanyakazi wa Vijijini na Fursa za Ndani",
            "All rights reserved.": "Haki zote zimehifadhiwa.",
            
            // Toast messages
            "Form cleared": "Fomu imefutwa",
            "Sorted by {criteria}": "Imepangwa kwa {criteria}",
            "Translating website...": "Inatafsiri tovuti...",
            "Page translated to English": "Kurasa imetafsiriwa kwa Kiingereza",
            "Page translated to Kiswahili": "Kurasa imetafsiriwa kwa Kiswahili",
            "Call": "Piga",
            "Sign Up as": "Jisajili kama"
        }
    };

    // Function to toggle between languages
    function toggleLanguage() {
        const newLanguage = currentLanguage === 'en' ? 'sw' : 'en';
        translatePage(newLanguage);
    }

    // Function to translate the entire page
    function translatePage(language) {
        // Show loader
        const loader = document.getElementById('translationLoader');
        if (loader) loader.style.display = 'flex';
        
        // Update current language
        currentLanguage = language;
        
        // Update language switcher
        const currentLanguageElement = document.getElementById('currentLanguage');
        if (currentLanguageElement) {
            currentLanguageElement.textContent = language === 'en' ? 'English' : 'Kiswahili';
        }
        
        // Translate all translatable elements
        setTimeout(() => {
            // Translate all text nodes that match translation keys
            const walker = document.createTreeWalker(
                document.body,
                NodeFilter.SHOW_TEXT,
                null,
                false
            );
            
            let node;
            const textNodes = [];
            while (node = walker.nextNode()) {
                if (node.textContent.trim() && 
                    Object.keys(translations.en).includes(node.textContent.trim())) {
                    textNodes.push(node);
                }
            }
            
            textNodes.forEach(node => {
                const key = node.textContent.trim();
                if (translations[language] && translations[language][key]) {
                    node.textContent = translations[language][key];
                }
            });
            
            // Translate placeholders
            const inputs = document.querySelectorAll('input, textarea');
            inputs.forEach(input => {
                const placeholder = input.getAttribute('placeholder');
                if (placeholder && translations[language] && translations[language][placeholder]) {
                    input.setAttribute('placeholder', translations[language][placeholder]);
                }
            });
            
            // Translate button text
            const buttons = document.querySelectorAll('button');
            buttons.forEach(button => {
                const text = button.textContent.trim();
                if (text && translations[language] && translations[language][text]) {
                    button.textContent = translations[language][text];
                }
            });
            
            // Translate select options
            const options = document.querySelectorAll('option');
            options.forEach(option => {
                const text = option.textContent.trim();
                if (text && translations[language] && translations[language][text]) {
                    option.textContent = translations[language][text];
                }
            });
            
            // Translate labels
            const labels = document.querySelectorAll('label');
            labels.forEach(label => {
                const text = label.textContent.trim();
                if (text && translations[language] && translations[language][text]) {
                    label.textContent = translations[language][text];
                }
            });
            
            // Hide loader
            if (loader) loader.style.display = 'none';
            
            // Show success message
            showToast(
                getTranslation('Page translated to ' + (language === 'en' ? 'English' : 'Kiswahili')), 
                'success'
            );
        }, 800);
    }

    // Function to get translated text
    function getTranslation(key, params = {}) {
        let text = translations[currentLanguage] && translations[currentLanguage][key] 
            ? translations[currentLanguage][key] 
            : (translations['en'][key] || key);
        
        // Replace parameters in the text
        Object.keys(params).forEach(param => {
            text = text.replace(`{${param}}`, params[param]);
        });
        
        return text;
    }

    // ========== AUTHENTICATION SYSTEM ==========
    let currentUser = null;
    let selectedRole = null;

    // Check if user is logged in
    function checkAuthentication() {
        const token = localStorage.getItem('token');
        const userData = localStorage.getItem('user');
        
        if (token && userData) {
            try {
                currentUser = JSON.parse(userData);
                updateUIForAuthenticatedUser();
            } catch (e) {
                console.error('Error parsing user data:', e);
                localStorage.removeItem('token');
                localStorage.removeItem('user');
            }
        } else {
            updateUIForGuest();
        }
    }

    // Setup authentication event listeners
    function setupAuthEventListeners() {
        document.getElementById('signup-form').addEventListener('submit', handleSignUp);
        document.getElementById('signin-form').addEventListener('submit', handleSignIn);
        
        const profileForm = document.getElementById('profile-form');
        const passwordForm = document.getElementById('password-form');
        
        if (profileForm) profileForm.addEventListener('submit', handleProfileUpdate);
        if (passwordForm) passwordForm.addEventListener('submit', handlePasswordChange);
    }

    // Show authentication modal
    function showAuthModal() {
        document.getElementById('authModal').style.display = 'flex';
        showRoleSelection();
    }

    // Close authentication modal
    function closeAuthModal() {
        document.getElementById('authModal').style.display = 'none';
    }

    // Show role selection
    function showRoleSelection() {
        document.getElementById('role-selection').style.display = 'block';
        document.getElementById('signup-form').style.display = 'none';
        document.getElementById('signin-form').style.display = 'none';
        document.getElementById('auth-modal-title').textContent = getTranslation('Join Kazi Mashinani');
        selectedRole = null;
        
        document.querySelectorAll('.auth-option').forEach(option => {
            option.classList.remove('active');
        });
    }

    // Show sign up form
    function showSignUp() {
        if (!selectedRole) return;
        
        document.getElementById('role-selection').style.display = 'none';
        document.getElementById('signup-form').style.display = 'block';
        document.getElementById('signin-form').style.display = 'none';
        
        const roleText = selectedRole === 'employee' ? getTranslation('Employee') : getTranslation('Employer');
        document.getElementById('auth-modal-title').textContent = getTranslation('Sign Up as') + ' ' + roleText;
        
        if (selectedRole === 'employee') {
            document.getElementById('signup-name-label').textContent = getTranslation('Full Name *');
            document.getElementById('specialization-group').style.display = 'block';
            document.getElementById('job-type-group').style.display = 'none';
        } else {
            document.getElementById('signup-name-label').textContent = getTranslation('Business/Organization Name *');
            document.getElementById('specialization-group').style.display = 'none';
            document.getElementById('job-type-group').style.display = 'block';
        }
    }

    // Show sign in form
    function showLogin() {
        document.getElementById('role-selection').style.display = 'none';
        document.getElementById('signup-form').style.display = 'none';
        document.getElementById('signin-form').style.display = 'block';
        document.getElementById('auth-modal-title').textContent = getTranslation('Sign In');
    }

    // Select role (employee or employer)
    function selectRole(role) {
        selectedRole = role;
        document.querySelectorAll('.auth-option').forEach(option => {
            option.classList.remove('active');
        });
        event.currentTarget.classList.add('active');
        
        setTimeout(() => {
            showSignUp();
        }, 300);
    }

    // Handle sign up
    async function handleSignUp(e) {
        e.preventDefault();
        
        const name = document.getElementById('signup-name').value.trim();
        const phone = document.getElementById('signup-phone').value.trim();
        const location = document.getElementById('signup-location').value.trim();
        const password = document.getElementById('signup-password').value;
        const confirmPassword = document.getElementById('signup-confirm-password').value;
        const specialization = document.getElementById('signup-specialization').value.trim();
        const jobType = document.getElementById('signup-job-type').value.trim();
        
        // Validation
        if (!name || !phone || !location || !password) {
            showToast(getTranslation('Please fill in all required fields'), 'error');
            return;
        }
        
        if (password.length < 6) {
            showToast(getTranslation('Password must be at least 6 characters'), 'error');
            return;
        }
        
        if (password !== confirmPassword) {
            showToast(getTranslation('Passwords do not match'), 'error');
            return;
        }
        
        const cleanPhone = phone.replace(/\D/g, '');
        const phoneRegex = /^(254|0)?[17]\d{8}$/;
        
        if (!phoneRegex.test(cleanPhone)) {
            showToast(getTranslation('Please enter a valid Kenyan phone number'), 'error');
            return;
        }
        
        try {
            // Check if account already exists with this phone number
            const checkResponse = await fetch(`${API_BASE_URL}/auth/check-phone`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    phone: cleanPhone
                })
            });
            
            const checkData = await checkResponse.json();
            
            if (checkData.exists) {
                showToast(getTranslation('An account with this phone number already exists'), 'error');
                return;
            }
            
            const response = await fetch(`${API_BASE_URL}/auth/signup`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    name,
                    phone: cleanPhone,
                    location,
                    password,
                    role: selectedRole,
                    specialization: selectedRole === 'employee' ? specialization : '',
                    jobType: selectedRole === 'employer' ? jobType : ''
                })
            });
            
            const data = await response.json();
            
            if (data.success) {
                localStorage.setItem('token', data.token);
                localStorage.setItem('user', JSON.stringify(data.user));
                currentUser = data.user;
                
                showToast(getTranslation('Account created successfully! Welcome to Kazi Mashinani'), 'success');
                closeAuthModal();
                updateUIForAuthenticatedUser();
                showSection('home');
                
                // Load appropriate data after successful signup
                if (currentUser.role === 'employee') {
                    await loadJobs();
                } else if (currentUser.role === 'employer') {
                    await loadEmployees();
                }
            } else {
                showToast(data.error || getTranslation('Sign up failed'), 'error');
            }
        } catch (error) {
            console.error('Sign up error:', error);
            showToast(getTranslation('Network error. Please check your connection and try again.'), 'error');
        }
    }

    // Handle sign in
    async function handleSignIn(e) {
        e.preventDefault();
        
        const phone = document.getElementById('signin-phone').value.trim();
        const password = document.getElementById('signin-password').value;
        
        if (!phone || !password) {
            showToast(getTranslation('Please enter phone number and password'), 'error');
            return;
        }
        
        const cleanPhone = phone.replace(/\D/g, '');
        
        try {
            const response = await fetch(`${API_BASE_URL}/auth/signin`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    phone: cleanPhone,
                    password
                })
            });
            
            const data = await response.json();
            
            if (data.success) {
                localStorage.setItem('token', data.token);
                localStorage.setItem('user', JSON.stringify(data.user));
                currentUser = data.user;
                
                showToast(getTranslation('Welcome back!') + ' ' + data.user.name, 'success');
                closeAuthModal();
                updateUIForAuthenticatedUser();
                showSection('home');
                
                // Load appropriate data after successful signin
                if (currentUser.role === 'employee') {
                    await loadJobs();
                } else if (currentUser.role === 'employer') {
                    await loadEmployees();
                }
            } else {
                showToast(data.error || getTranslation('Sign in failed'), 'error');
            }
        } catch (error) {
            console.error('Sign in error:', error);
            showToast(getTranslation('Network error. Please check your connection and try again.'), 'error');
        }
    }

    // Handle profile update
    async function handleProfileUpdate(e) {
        e.preventDefault();
        
        const name = document.getElementById('profile-name').value.trim();
        const location = document.getElementById('profile-location').value.trim();
        const specialization = document.getElementById('profile-specialization').value.trim();
        const jobType = document.getElementById('profile-job-type').value.trim();
        
        if (!name || !location) {
            showToast(getTranslation('Please fill in all required fields'), 'error');
            return;
        }
        
        try {
            const token = localStorage.getItem('token');
            const response = await fetch(`${API_BASE_URL}/auth/profile`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({
                    phone: currentUser.phone,
                    name,
                    location,
                    specialization,
                    jobType
                })
            });
            
            const data = await response.json();
            
            if (data.success) {
                localStorage.setItem('user', JSON.stringify(data.user));
                currentUser = data.user;
                
                showToast(getTranslation('Profile updated successfully'), 'success');
                closeProfileModal();
                updateUIForAuthenticatedUser();
            } else {
                showToast(data.error || getTranslation('Profile update failed'), 'error');
            }
        } catch (error) {
            console.error('Profile update error:', error);
            showToast(getTranslation('Network error. Please try again.'), 'error');
        }
    }

    // Handle password change
    async function handlePasswordChange(e) {
        e.preventDefault();
        
        const currentPassword = document.getElementById('current-password').value;
        const newPassword = document.getElementById('new-password').value;
        const confirmNewPassword = document.getElementById('confirm-new-password').value;
        
        if (!currentPassword || !newPassword || !confirmNewPassword) {
            showToast(getTranslation('Please fill in all fields'), 'error');
            return;
        }
        
        if (newPassword.length < 6) {
            showToast(getTranslation('New password must be at least 6 characters'), 'error');
            return;
        }
        
        if (newPassword !== confirmNewPassword) {
            showToast(getTranslation('New passwords do not match'), 'error');
            return;
        }
        
        try {
            const token = localStorage.getItem('token');
            const response = await fetch(`${API_BASE_URL}/auth/password`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({
                    phone: currentUser.phone,
                    currentPassword,
                    newPassword
                })
            });
            
            const data = await response.json();
            
            if (data.success) {
                showToast(getTranslation('Password changed successfully'), 'success');
                closePasswordModal();
                document.getElementById('password-form').reset();
            } else {
                showToast(data.error || getTranslation('Password change failed'), 'error');
            }
        } catch (error) {
            console.error('Password change error:', error);
            showToast(getTranslation('Network error. Please try again.'), 'error');
        }
    }

    // Logout function
    function logout() {
        localStorage.removeItem('token');
        localStorage.removeItem('user');
        currentUser = null;
        updateUIForGuest();
        showSection('home');
        showToast(getTranslation('You have been signed out'), 'info');
    }

    // Update UI for authenticated user
    function updateUIForAuthenticatedUser() {
        const headerRight = document.querySelector('.header-right');
        const existingUserInfo = document.querySelector('.user-info');
        
        if (existingUserInfo) {
            existingUserInfo.remove();
        }
        
        const userInfo = document.createElement('div');
        userInfo.className = 'user-info';
        userInfo.onclick = () => showSection('profile');
        userInfo.innerHTML = `
            <div class="user-avatar">
                <i class="fas fa-user"></i>
            </div>
            <div class="user-name">${currentUser.name}</div>
        `;
        
        headerRight.appendChild(userInfo);
        
        // Update navigation based on role
        updateNavigationForRole();
        
        // Update profile section
        updateProfileSection();
    }

    // Update navigation based on user role
    function updateNavigationForRole() {
        const postJobNav = document.getElementById('post-job-nav');
        const jobsNav = document.getElementById('jobs-nav');
        const employeesNav = document.getElementById('employees-nav');
        const postJobAction = document.getElementById('post-job-action');
        const findEmployeesAction = document.getElementById('find-employees-action');
        
        if (currentUser.role === 'employee') {
            // Employees can search for jobs but not post them
            postJobNav.style.display = 'none';
            employeesNav.style.display = 'none';
            jobsNav.style.display = 'flex';
            postJobAction.style.display = 'none';
            findEmployeesAction.style.display = 'none';
        } else if (currentUser.role === 'employer') {
            // Employers can post jobs and view employees but not view jobs
            postJobNav.style.display = 'flex';
            employeesNav.style.display = 'flex';
            jobsNav.style.display = 'none';
            postJobAction.style.display = 'block';
            findEmployeesAction.style.display = 'block';
        }
    }

    // Update UI for guest user
    function updateUIForGuest() {
        const userInfo = document.querySelector('.user-info');
        if (userInfo) {
            userInfo.remove();
        }
        
        // Reset navigation to default
        const postJobNav = document.getElementById('post-job-nav');
        const jobsNav = document.getElementById('jobs-nav');
        const employeesNav = document.getElementById('employees-nav');
        const postJobAction = document.getElementById('post-job-action');
        const findEmployeesAction = document.getElementById('find-employees-action');
        
        postJobNav.style.display = 'none';
        employeesNav.style.display = 'none';
        jobsNav.style.display = 'flex';
        postJobAction.style.display = 'none';
        findEmployeesAction.style.display = 'none';
        
        // Update profile section to show auth required
        updateProfileSection();
    }

    // Update profile section based on authentication status
    function updateProfileSection() {
        const profileSection = document.getElementById('profile');
        if (!profileSection) return;
        
        if (currentUser) {
            profileSection.innerHTML = `
                <div class="container">
                    <div class="profile-header">
                        <div class="profile-avatar">
                            <i class="fas fa-user"></i>
                        </div>
                        <div class="profile-info">
                            <h2>${currentUser.name}</h2>
                            <p>${currentUser.role === 'employee' ? getTranslation('Employee') : getTranslation('Employer')} • ${getTranslation('Member since')} ${new Date(currentUser.joinDate).toLocaleDateString()}</p>
                        </div>
                    </div>

                    <div class="profile-actions">
                        <button class="btn-primary" onclick="openProfileModal()">
                            <i class="fas fa-edit"></i> ${getTranslation('Edit Profile')}
                        </button>
                        <button class="btn-secondary" onclick="openPasswordModal()">
                            <i class="fas fa-key"></i> ${getTranslation('Change Password')}
                        </button>
                        <button class="btn-delete" onclick="logout()">
                            <i class="fas fa-sign-out-alt"></i> ${getTranslation('Log Out')}
                        </button>
                    </div>

                    <div class="profile-details">
                        <div class="detail-item">
                            <span class="detail-label">${getTranslation('Mobile Number')}</span>
                            <span class="detail-value">${currentUser.phone}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">${getTranslation('Location')}</span>
                            <span class="detail-value">${currentUser.location}</span>
                        </div>
                        ${currentUser.role === 'employee' ? `
                            <div class="detail-item">
                                <span class="detail-label">${getTranslation('Specialization')}</span>
                                <span class="detail-value">${currentUser.specialization || getTranslation('Not specified')}</span>
                            </div>
                        ` : `
                            <div class="detail-item">
                                <span class="detail-label">${getTranslation('Job Types')}</span>
                                <span class="detail-value">${currentUser.jobType || getTranslation('Not specified')}</span>
                            </div>
                        `}
                        <div class="detail-item">
                            <span class="detail-label">${getTranslation('Last Login')}</span>
                            <span class="detail-value">${new Date(currentUser.lastLogin).toLocaleString()}</span>
                        </div>
                    </div>

                    ${currentUser.role === 'employer' ? `
                        <div class="section-header">
                            <i class="fas fa-briefcase"></i>
                            <h2>${getTranslation('My Posted Jobs')}</h2>
                        </div>

                        <div id="profile-message"></div>

                        <div class="my-jobs-list" id="my-jobs-list">
                            <!-- My jobs will be displayed here -->
                        </div>
                    ` : `
                        <div class="auth-required">
                            <div class="action-icon">
                                <i class="fas fa-briefcase"></i>
                            </div>
                            <h2>${getTranslation('Find Jobs')}</h2>
                            <p>${getTranslation('Browse available job opportunities in your area.')}</p>
                            <button class="btn-primary" onclick="showSection('jobs')" style="margin-top: 1.5rem;">
                                <i class="fas fa-search"></i> ${getTranslation('Browse Jobs')}
                            </button>
                        </div>
                    `}
                </div>
            `;
            
            // Load user's jobs if employer
            if (currentUser.role === 'employer') {
                setTimeout(() => {
                    loadMyJobs();
                }, 100);
            }
        } else {
            profileSection.innerHTML = `
                <div class="container">
                    <div class="auth-required">
                        <div class="action-icon">
                            <i class="fas fa-user-lock"></i>
                        </div>
                        <h2>${getTranslation('Authentication Required')}</h2>
                        <p>${getTranslation('Please sign in to view your profile and manage your jobs.')}</p>
                        <button class="btn-primary" onclick="showAuthModal()" style="margin-top: 1.5rem;">
                            <i class="fas fa-sign-in-alt"></i> ${getTranslation('Sign In / Sign Up')}
                        </button>
                    </div>
                </div>
            `;
        }
    }

    // Open profile edit modal
    function openProfileModal() {
        if (!currentUser) return;
        
        document.getElementById('profile-name').value = currentUser.name;
        document.getElementById('profile-phone').value = currentUser.phone;
        document.getElementById('profile-location').value = currentUser.location;
        
        if (currentUser.role === 'employee') {
            document.getElementById('profile-specialization-group').style.display = 'block';
            document.getElementById('profile-job-type-group').style.display = 'none';
            document.getElementById('profile-specialization').value = currentUser.specialization || '';
        } else {
            document.getElementById('profile-specialization-group').style.display = 'none';
            document.getElementById('profile-job-type-group').style.display = 'block';
            document.getElementById('profile-job-type').value = currentUser.jobType || '';
        }
        
        document.getElementById('profileModal').style.display = 'flex';
    }

    // Close profile edit modal
    function closeProfileModal() {
        document.getElementById('profileModal').style.display = 'none';
    }

    // Open password change modal
    function openPasswordModal() {
        document.getElementById('passwordModal').style.display = 'flex';
    }

    // Close password change modal
    function closePasswordModal() {
        document.getElementById('passwordModal').style.display = 'none';
    }

    // ========== JOB MANAGEMENT SYSTEM ==========
    let currentJobs = [];
    let currentEmployees = [];
    let currentPage = 1;
    const itemsPerPage = 5;
    let currentSort = 'newest';

    // Initialize the application
    async function initializeApp() {
        console.log('Initializing app...');
        checkAuthentication();
        setupAuthEventListeners();
        setupEventListeners();
        await loadJobs();
        await loadEmployees();
    }

    function setupEventListeners() {
        const jobForm = document.getElementById('job-form');
        const editJobForm = document.getElementById('edit-job-form');
        const searchInput = document.getElementById('search-input');
        
        if (jobForm) jobForm.addEventListener('submit', handleJobSubmit);
        if (editJobForm) editJobForm.addEventListener('submit', handleJobEdit);
        
        if (searchInput) {
            searchInput.addEventListener('input', debounce(handleSearchInput, 300));
        }
    }

    // Phone Number Formatting
    function formatPhoneNumber(input) {
        let value = input.value.replace(/\D/g, '');
        
        if (value.startsWith('0')) {
            value = value.substring(1);
        }
        
        if (value.length > 0 && !value.startsWith('254')) {
            value = '254' + value;
        }
        
        if (value.length > 12) {
            value = value.substring(0, 12);
        }
        
        input.value = value;
    }

    // Format phone for display and calling
    function formatPhoneForCall(phone) {
        if (!phone) return '';
        let digits = phone.replace(/\D/g, '');
        
        if (digits.startsWith('254')) {
            return '+254' + digits.substring(3);
        }
        
        return '+254' + digits;
    }

    // WhatsApp Integration
    function generateWhatsAppLink(phone, message) {
        const formattedPhone = formatPhoneForCall(phone);
        return `https://wa.me/${formattedPhone.replace('+', '')}?text=${encodeURIComponent(message)}`;
    }

    // Load jobs from API with performance optimization
    async function loadJobs() {
        try {
            console.log('Loading jobs from:', `${API_BASE_URL}/jobs`);
            showMessage(getTranslation('Loading jobs...'), 'info', 'jobs');
            
            // Add cache-busting to prevent caching issues
            const response = await fetch(`${API_BASE_URL}/jobs?t=${Date.now()}`);
            console.log('Response status:', response.status);
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const data = await response.json();
            console.log('Jobs data received:', data);
            
            if (data && data.success && Array.isArray(data.jobs)) {
                currentJobs = data.jobs;
                console.log(`Loaded ${currentJobs.length} jobs`);
            } else {
                currentJobs = [];
                console.log('No jobs found or invalid response format');
            }
            
            applyCurrentSort();
            displayJobs(currentJobs);
            updatePagination();
            showMessage('', 'success', 'jobs');
            
        } catch (error) {
            console.error('Error loading jobs:', error);
            showMessage(getTranslation('Failed to load jobs from server. Please check your connection.'), 'error', 'jobs');
            
            // Show sample data for demo purposes
            showSampleJobData();
        }
    }

    // Load employees from API with performance optimization
    async function loadEmployees() {
        try {
            console.log('Loading employees from:', `${API_BASE_URL}/employees`);
            showMessage(getTranslation('Loading employees...'), 'info', 'employees');
            
            // Add cache-busting to prevent caching issues
            const response = await fetch(`${API_BASE_URL}/employees?t=${Date.now()}`);
            console.log('Response status:', response.status);
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const data = await response.json();
            console.log('Employees data received:', data);
            
            if (data && data.success && Array.isArray(data.employees)) {
                currentEmployees = data.employees;
                console.log(`Loaded ${currentEmployees.length} employees`);
            } else {
                currentEmployees = [];
                console.log('No employees found or invalid response format');
            }
            
            applyCurrentEmployeeSort();
            displayEmployees(currentEmployees);
            updateEmployeesPagination();
            showMessage('', 'success', 'employees');
            
        } catch (error) {
            console.error('Error loading employees:', error);
            showMessage(getTranslation('Failed to load employees from server. Please check your connection.'), 'error', 'employees');
            
            // Show sample data for demo purposes
            showSampleEmployeeData();
        }
    }

    // Show sample job data when API fails
    function showSampleJobData() {
        console.log('Showing sample job data');
        const sampleJobs = [
            {
                _id: '1',
                title: 'Farm Worker Needed',
                description: 'Looking for experienced farm workers for seasonal harvest. Must have knowledge of modern farming techniques.',
                location: 'Nakuru',
                category: 'agriculture',
                phone: '254712345678',
                whatsapp: '254712345678',
                businessType: 'Farm',
                employerId: 'sample1',
                postedDate: new Date().toISOString()
            },
            {
                _id: '2',
                title: 'Construction Helper',
                description: 'Immediate opening for construction helpers at a new site. No experience required, training provided.',
                location: 'Kiambu',
                category: 'construction',
                phone: '254723456789',
                businessType: 'Construction Company',
                employerId: 'sample2',
                postedDate: new Date(Date.now() - 86400000).toISOString()
            },
            {
                _id: '3',
                title: 'Domestic Helper',
                description: 'Reliable domestic helper needed for household chores and childcare. Must be trustworthy and hardworking.',
                location: 'Nairobi',
                category: 'domestic',
                phone: '254734567890',
                businessType: 'Individual',
                employerId: 'sample3',
                postedDate: new Date(Date.now() - 172800000).toISOString()
            }
        ];
        
        currentJobs = sampleJobs;
        applyCurrentSort();
        displayJobs(currentJobs);
        updatePagination();
        
        showMessage(getTranslation('Showing sample data. Server connection failed.'), 'warning', 'jobs');
    }

    // Show sample employee data when API fails
    function showSampleEmployeeData() {
        console.log('Showing sample employee data');
        const sampleEmployees = [
            {
                _id: '1',
                name: 'John Kamau',
                phone: '254712345678',
                location: 'Nakuru',
                specialization: 'Farming, Construction',
                experience: '5 years',
                joinDate: new Date(Date.now() - 86400000).toISOString()
            },
            {
                _id: '2',
                name: 'Mary Wanjiku',
                phone: '254723456789',
                location: 'Kiambu',
                specialization: 'Domestic Work, Childcare',
                experience: '3 years',
                joinDate: new Date(Date.now() - 172800000).toISOString()
            },
            {
                _id: '3',
                name: 'Peter Ochieng',
                phone: '254734567890',
                location: 'Nairobi',
                specialization: 'Driving, Delivery',
                experience: '7 years',
                joinDate: new Date(Date.now() - 259200000).toISOString()
            }
        ];
        
        currentEmployees = sampleEmployees;
        applyCurrentEmployeeSort();
        displayEmployees(currentEmployees);
        updateEmployeesPagination();
        
        showMessage(getTranslation('Showing sample data. Server connection failed.'), 'warning', 'employees');
    }

    // Handle job submission
    async function handleJobSubmit(e) {
        e.preventDefault();
        
        if (!currentUser) {
            showAuthModal();
            return;
        }

        if (!validateForm()) return;

        const jobData = collectFormData();
        const submitButton = document.querySelector('#job-form button[type="submit"]');
        
        submitButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ' + (currentLanguage === 'en' ? 'Posting...' : 'Inatumwa...');
        submitButton.disabled = true;

        try {
            const token = localStorage.getItem('token');
            const response = await fetch(`${API_BASE_URL}/jobs`, {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify(jobData)
            });

            const result = await response.json();
            console.log('Post job response:', result);

            if (result.success) {
                // Add to current jobs and update UI
                currentJobs.unshift(result.job);
                displayJobs(currentJobs);
                
                showMessage(getTranslation('Job posted successfully!'), 'success', 'post');
                document.getElementById('job-form').reset();
                showToast(getTranslation('Job posted successfully!'), 'success');

                setTimeout(() => {
                    showSection('profile');
                }, 1500);
            } else {
                throw new Error(result.error || getTranslation('Failed to post job'));
            }
            
        } catch (error) {
            console.error('Post job error:', error);
            showMessage(getTranslation('Failed to post job. Please try again.'), 'error', 'post');
            showToast(getTranslation('Failed to post job'), 'error');
        } finally {
            submitButton.innerHTML = '<i class="fas fa-paper-plane"></i> ' + getTranslation('Post Job');
            submitButton.disabled = false;
        }
    }

    function validateForm() {
        const title = document.getElementById('job-title').value.trim();
        const description = document.getElementById('job-description').value.trim();
        const location = document.getElementById('job-location').value.trim();
        const phone = document.getElementById('employer-phone').value.trim();

        if (!title || title.length < 3) {
            showMessage(getTranslation('Job title must be at least 3 characters'), 'error', 'post');
            return false;
        }

        if (!description || description.length < 10) {
            showMessage(getTranslation('Please provide a detailed job description'), 'error', 'post');
            return false;
        }

        if (!location) {
            showMessage(getTranslation('Location is required'), 'error', 'post');
            return false;
        }

        if (!phone) {
            showMessage(getTranslation('Phone number is required'), 'error', 'post');
            return false;
        }

        const cleanPhone = phone.replace(/\D/g, '');
        const phoneRegex = /^(254|0)?[17]\d{8}$/;
        
        if (!phoneRegex.test(cleanPhone)) {
            showMessage(getTranslation('Please enter a valid Kenyan phone number (e.g., 712345678)'), 'error', 'post');
            return false;
        }

        return true;
    }

    function collectFormData() {
        const formatPhone = (phone) => {
            return phone.replace(/\D/g, '');
        };
        
        const phone = document.getElementById('employer-phone').value.trim();
        const whatsapp = document.getElementById('employer-whatsapp').value.trim();
        
        return {
            title: document.getElementById('job-title').value.trim(),
            description: document.getElementById('job-description').value.trim(),
            location: document.getElementById('job-location').value.trim(),
            category: document.getElementById('job-category').value,
            phone: formatPhone(phone),
            whatsapp: whatsapp ? formatPhone(whatsapp) : '',
            businessType: document.getElementById('business-type').value.trim() || getTranslation('Individual')
        };
    }

    // Load user's jobs
    async function loadMyJobs() {
        const myJobsList = document.getElementById('my-jobs-list');
        if (!myJobsList) return;
        
        try {
            // For now, filter from currentJobs since we don't have user-specific endpoint
            const myJobs = currentJobs.filter(job => job.employerId === currentUser._id);
            
            if (myJobs.length === 0) {
                myJobsList.innerHTML = `<div class="message info">${getTranslation('You haven\'t posted any jobs yet.')} <a href="#" onclick="showSection('post')">${getTranslation('Post your first job')}</a></div>`;
                return;
            }
            
            myJobsList.innerHTML = myJobs.map(job => `
                <div class="my-job-card" data-job-id="${job._id}">
                    <div class="my-job-header">
                        <div>
                            <h3 class="my-job-title">${job.title} <span class="category-badge">${job.category}</span></h3>
                            <div class="my-job-meta">
                                <div class="my-job-meta-item">
                                    <i class="fas fa-map-marker-alt"></i>
                                    <span>${job.location}</span>
                                </div>
                                <div class="my-job-meta-item">
                                    <i class="fas fa-calendar"></i>
                                    <span>${new Date(job.postedDate).toLocaleDateString()}</span>
                                </div>
                            </div>
                        </div>
                        <div class="my-job-actions">
                            <button class="btn-edit" onclick="openEditModal('${job._id}')">
                                <i class="fas fa-edit"></i> ${getTranslation('Edit')}
                            </button>
                            <button class="btn-delete" onclick="deleteJob('${job._id}')">
                                <i class="fas fa-trash"></i> ${getTranslation('Delete')}
                            </button>
                        </div>
                    </div>
                    <p>${job.description}</p>
                </div>
            `).join('');
        } catch (error) {
            console.error('Error loading my jobs:', error);
            myJobsList.innerHTML = `<div class="message error">${getTranslation('Failed to load your jobs')}</div>`;
        }
    }

    // Edit job functionality
    function openEditModal(jobId) {
        const job = currentJobs.find(j => j._id === jobId);
        if (!job) return;
        
        document.getElementById('edit-job-id').value = job._id;
        document.getElementById('edit-job-title').value = job.title;
        document.getElementById('edit-job-description').value = job.description;
        document.getElementById('edit-job-location').value = job.location;
        document.getElementById('edit-job-category').value = job.category;
        
        document.getElementById('editJobModal').style.display = 'flex';
    }

    function closeEditModal() {
        document.getElementById('editJobModal').style.display = 'none';
    }

    async function handleJobEdit(e) {
        e.preventDefault();
        
        const jobId = document.getElementById('edit-job-id').value;
        
        const updatedJob = {
            title: document.getElementById('edit-job-title').value.trim(),
            description: document.getElementById('edit-job-description').value.trim(),
            location: document.getElementById('edit-job-location').value.trim(),
            category: document.getElementById('edit-job-category').value
        };
        
        try {
            const token = localStorage.getItem('token');
            const response = await fetch(`${API_BASE_URL}/jobs/${jobId}`, {
                method: 'PUT',
                headers: { 
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify(updatedJob)
            });
            
            const data = await response.json();
            
            if (data.success) {
                // Update local jobs array
                const jobIndex = currentJobs.findIndex(j => j._id === jobId);
                if (jobIndex !== -1) {
                    currentJobs[jobIndex] = { ...currentJobs[jobIndex], ...updatedJob };
                }
                
                displayJobs(currentJobs);
                loadMyJobs();
                
                closeEditModal();
                showToast(getTranslation('Job updated successfully!'), 'success');
            } else {
                throw new Error(data.error);
            }
            
        } catch (error) {
            console.error('Update job error:', error);
            showToast(getTranslation('Failed to update job'), 'error');
        }
    }

    // Delete job functionality
    async function deleteJob(jobId) {
        if (!confirm(getTranslation('Are you sure you want to delete this job?'))) return;
        
        try {
            const token = localStorage.getItem('token');
            const response = await fetch(`${API_BASE_URL}/jobs/${jobId}`, {
                method: 'DELETE',
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });
            
            const data = await response.json();
            
            if (data.success) {
                // Remove from current jobs
                currentJobs = currentJobs.filter(job => job._id !== jobId);
                displayJobs(currentJobs);
                loadMyJobs();
                
                showToast(getTranslation('Job deleted successfully!'), 'success');
            } else {
                throw new Error(data.error);
            }
            
        } catch (error) {
            console.error('Delete job error:', error);
            showToast(getTranslation('Failed to delete job'), 'error');
        }
    }

    // ========== SEARCH FUNCTIONALITY ==========
    function handleSearchInput(e) {
        const query = e.target.value.toLowerCase();
        
        if (query.length < 2) {
            displaySearchResults(currentJobs);
            return;
        }
        
        const filteredJobs = currentJobs.filter(job => 
            job.title.toLowerCase().includes(query) ||
            job.description.toLowerCase().includes(query) ||
            job.location.toLowerCase().includes(query) ||
            job.category.toLowerCase().includes(query)
        );
        displaySearchResults(filteredJobs);
    }

    function displaySearchResults(jobs) {
        const results = document.getElementById('search-results');
        const message = document.getElementById('search-message');
        
        results.innerHTML = '';
        
        if (!jobs || jobs.length === 0) {
            message.innerHTML = `<div class="message info">${getTranslation('No jobs found matching your search.')}</div>`;
            return;
        }
        
        message.innerHTML = `<div class="message success">${getTranslation('Found {count} jobs', {count: jobs.length})}</div>`;
        
        jobs.forEach(job => {
            const div = document.createElement('div');
            div.className = 'job-listing';
            div.innerHTML = generateJobHTML(job);
            results.appendChild(div);
        });
    }

    // ========== JOB DISPLAY FUNCTIONS ==========
    function generateJobHTML(job) {
        const postedDate = new Date(job.postedDate).toLocaleDateString();
        const formattedPhone = formatPhoneForCall(job.phone);
        
        // Check if user is authenticated to show contact details
        const showContacts = currentUser && currentUser.role === 'employee';
        
        return `
            <div class="job-listing" data-job-id="${job._id}">
                <div class="job-details">
                    <div class="job-content">
                        <h3>${job.title} <span class="category-badge">${job.category}</span></h3>
                        <p>${job.description}</p>
                        <div class="job-meta">
                            <div class="meta-item">
                                <i class="fas fa-map-marker-alt"></i>
                                <span>${job.location}</span>
                            </div>
                            <div class="meta-item">
                                <i class="fas fa-calendar"></i>
                                <span>${postedDate}</span>
                            </div>
                            <div class="meta-item">
                                <i class="fas fa-building"></i>
                                <span>${job.businessType || getTranslation('Individual')}</span>
                            </div>
                        </div>
                    </div>
                    <div class="communication">
                        ${showContacts ? `
                            <a href="tel:${formattedPhone}" class="btn-call">
                                <i class="fas fa-phone"></i> ${getTranslation('Call')}
                            </a>
                            ${job.whatsapp || job.phone ? `
                                <a href="${generateWhatsAppLink(job.whatsapp || job.phone, getTranslation('Hi, I am interested in joining ') + job.title + getTranslation(' position.'))}" class="btn-whatsapp" target="_blank">
                                    <i class="fab fa-whatsapp"></i> WhatsApp
                                </a>
                            ` : ''}
                        ` : `
                            <button class="btn-primary" onclick="showAuthModal()">
                                <i class="fas fa-sign-in-alt"></i> ${getTranslation('Sign In to Contact')}
                            </button>
                        `}
                    </div>
                </div>
            </div>
        `;
    }

    function displayJobs(jobs) {
        const container = document.getElementById('job-listings');
        if (!container) return;
            
        if (!jobs || jobs.length === 0) {
            container.innerHTML = `<div class="message info">${getTranslation('No jobs found. Be the first to post a job!')}</div>`;
            return;
        }
        
        const startIndex = (currentPage - 1) * itemsPerPage;
        const paginatedJobs = jobs.slice(startIndex, startIndex + itemsPerPage);
        
        container.innerHTML = paginatedJobs.map(job => generateJobHTML(job)).join('');
    }

    function updatePagination() {
        const totalPages = Math.ceil(currentJobs.length / itemsPerPage);
        const container = document.getElementById('pagination');
        if (!container || totalPages <= 1) {
            container.innerHTML = '';
            return;
        }
        
        let paginationHTML = '';
        
        if (currentPage > 1) {
            paginationHTML += `<button class="page-btn" onclick="currentPage = ${currentPage - 1}; displayJobs(currentJobs);">
                <i class="fas fa-chevron-left"></i> ${getTranslation('Previous')}
            </button>`;
        }
        
        for (let i = 1; i <= totalPages; i++) {
            paginationHTML += `<button class="page-btn ${i === currentPage ? 'active' : ''}" 
                onclick="currentPage = ${i}; displayJobs(currentJobs);">${i}</button>`;
        }
        
        if (currentPage < totalPages) {
            paginationHTML += `<button class="page-btn" onclick="currentPage = ${currentPage + 1}; displayJobs(currentJobs);">
                ${getTranslation('Next')} <i class="fas fa-chevron-right"></i>
            </button>`;
        }
        
        container.innerHTML = paginationHTML;
    }

    // ========== EMPLOYEE DISPLAY FUNCTIONS ==========
    function generateEmployeeHTML(employee) {
        const joinDate = new Date(employee.joinDate).toLocaleDateString();
        const formattedPhone = formatPhoneForCall(employee.phone);
        
        // Check if user is authenticated to show contact details
        const showContacts = currentUser && currentUser.role === 'employer';
        
        return `
            <div class="employee-listing" data-employee-id="${employee._id}">
                <div class="employee-details">
                    <div class="employee-content">
                        <h3>${employee.name}</h3>
                        <p>${employee.specialization || getTranslation('No specialization specified')}</p>
                        <div class="employee-meta">
                            <div class="meta-item">
                                <i class="fas fa-map-marker-alt"></i>
                                <span>${employee.location}</span>
                            </div>
                            <div class="meta-item">
                                <i class="fas fa-calendar"></i>
                                <span>${joinDate}</span>
                            </div>
                            <div class="meta-item">
                                <i class="fas fa-briefcase"></i>
                                <span>${employee.experience || getTranslation('Experience not specified')}</span>
                            </div>
                        </div>
                    </div>
                    <div class="communication">
                        ${showContacts ? `
                            <a href="tel:${formattedPhone}" class="btn-call">
                                <i class="fas fa-phone"></i> ${getTranslation('Call')}
                            </a>
                            <a href="${generateWhatsAppLink(employee.phone, getTranslation('Hi, I have a job opportunity that might interest you.'))}" class="btn-whatsapp" target="_blank">
                                <i class="fab fa-whatsapp"></i> WhatsApp
                            </a>
                        ` : `
                            <button class="btn-primary" onclick="showAuthModal()">
                                <i class="fas fa-sign-in-alt"></i> ${getTranslation('Sign In to Contact')}
                            </button>
                        `}
                    </div>
                </div>
            </div>
        `;
    }

    function displayEmployees(employees) {
        const container = document.getElementById('employee-listings');
        if (!container) return;
            
        if (!employees || employees.length === 0) {
            container.innerHTML = `<div class="message info">${getTranslation('No employees found.')}</div>`;
            return;
        }
        
        const startIndex = (currentPage - 1) * itemsPerPage;
        const paginatedEmployees = employees.slice(startIndex, startIndex + itemsPerPage);
        
        container.innerHTML = paginatedEmployees.map(employee => generateEmployeeHTML(employee)).join('');
    }

    function updateEmployeesPagination() {
        const totalPages = Math.ceil(currentEmployees.length / itemsPerPage);
        const container = document.getElementById('employees-pagination');
        if (!container || totalPages <= 1) {
            container.innerHTML = '';
            return;
        }
        
        let paginationHTML = '';
        
        if (currentPage > 1) {
            paginationHTML += `<button class="page-btn" onclick="currentPage = ${currentPage - 1}; displayEmployees(currentEmployees);">
                <i class="fas fa-chevron-left"></i> ${getTranslation('Previous')}
            </button>`;
        }
        
        for (let i = 1; i <= totalPages; i++) {
            paginationHTML += `<button class="page-btn ${i === currentPage ? 'active' : ''}" 
                onclick="currentPage = ${i}; displayEmployees(currentEmployees);">${i}</button>`;
        }
        
        if (currentPage < totalPages) {
            paginationHTML += `<button class="page-btn" onclick="currentPage = ${currentPage + 1}; displayEmployees(currentEmployees);">
                ${getTranslation('Next')} <i class="fas fa-chevron-right"></i>
            </button>`;
        }
        
        container.innerHTML = paginationHTML;
    }

    // ========== UTILITY FUNCTIONS ==========
    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }

    // Toast Notifications
    function showToast(message, type) {
        const toastContainer = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.innerHTML = `
            <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
            <div>${message}</div>
        `;
        
        toastContainer.appendChild(toast);
        
        setTimeout(() => {
            toast.remove();
        }, 3000);
    }

    function showMessage(message, type, section) {
        const container = document.getElementById(`${section}-message`);
        if (container) {
            container.innerHTML = `<div class="message ${type}">${message}</div>`;
            
            if (type === 'success') {
                setTimeout(() => {
                    container.innerHTML = '';
                }, 5000);
            }
        }
    }

    // Section Navigation with Auth Check
    function showSection(sectionId) {
        // Check authentication for protected sections
        if ((sectionId === 'profile' || sectionId === 'post' || sectionId === 'employees') && !currentUser) {
            showAuthModal();
            return;
        }
        
        // Check role-based access
        if (sectionId === 'jobs' && currentUser && currentUser.role === 'employer') {
            showSection('employees');
            return;
        }
        
        if (sectionId === 'employees' && currentUser && currentUser.role === 'employee') {
            showSection('jobs');
            return;
        }
        
        document.querySelectorAll('section').forEach(section => {
            section.style.display = 'none';
        });
        
        const targetSection = document.getElementById(sectionId);
        if (targetSection) {
            targetSection.style.display = 'block';
            
            // Load appropriate data when showing sections
            if (sectionId === 'jobs' && currentUser && currentUser.role === 'employee') {
                loadJobs();
            } else if (sectionId === 'employees' && currentUser && currentUser.role === 'employer') {
                loadEmployees();
            }
        }
        
        document.querySelectorAll('.nav-item').forEach(item => {
            item.classList.remove('active');
        });
        
        const activeItem = Array.from(document.querySelectorAll('.nav-item'))
            .find(item => {
                const text = item.querySelector('.nav-text').textContent.toLowerCase();
                return text.includes(sectionId.toLowerCase());
            });
            
        if (activeItem) {
            activeItem.classList.add('active');
        }
        
        // If showing profile, reload my jobs
        if (sectionId === 'profile' && currentUser) {
            updateProfileSection();
        }
    }

    // Sorting functions
    function sortJobs(criteria) {
        currentSort = criteria;
        applyCurrentSort();
        displayJobs(currentJobs);
        showToast(getTranslation('Sorted by {criteria}', {criteria: getTranslation(criteria)}), 'info');
    }

    function applyCurrentSort() {
        switch (currentSort) {
            case 'newest':
                currentJobs.sort((a, b) => new Date(b.postedDate) - new Date(a.postedDate));
                break;
            case 'location':
                currentJobs.sort((a, b) => a.location.localeCompare(b.location));
                break;
            case 'category':
                currentJobs.sort((a, b) => a.category.localeCompare(b.category));
                break;
        }
    }

    function sortEmployees(criteria) {
        currentSort = criteria;
        applyCurrentEmployeeSort();
        displayEmployees(currentEmployees);
        showToast(getTranslation('Sorted by {criteria}', {criteria: getTranslation(criteria)}), 'info');
    }

    function applyCurrentEmployeeSort() {
        switch (currentSort) {
            case 'name':
                currentEmployees.sort((a, b) => a.name.localeCompare(b.name));
                break;
            case 'location':
                currentEmployees.sort((a, b) => a.location.localeCompare(b.location));
                break;
            case 'specialization':
                currentEmployees.sort((a, b) => (a.specialization || '').localeCompare(b.specialization || ''));
                break;
        }
    }

    function clearForm() {
        document.getElementById('job-form').reset();
        showToast(getTranslation('Form cleared'), 'info');
    }

    // ========== BLOG FUNCTIONALITY ==========
    const blogContent = {
        'agriculture': {
            title: getTranslation('Agriculture Opportunities Growing in Rural Areas'),
            icon: 'fas fa-tractor',
            content: {
                en: '<h3>The Growing Demand for Agricultural Workers</h3><p>Rural Kenya is experiencing a significant increase in agricultural job opportunities as the sector continues to expand. From small-scale family farms to large commercial agricultural enterprises, there is a growing need for skilled and unskilled labor across various agricultural subsectors.</p>',
                sw: '<h3>Mahitaji Yanayoongezeka kwa Wafanyakazi wa Kilimo</h3><p>Kenya ya Vijijini inapata ongezeko kubwa la fursa za kazi za kilimo kadri sekta inavyoendelea kupanua. Kutoka kwa mashamba madogo ya familia hadi makampuni makubwa ya kilimo ya kibiashara, kuna hitaji linaloongezeka la wafanyikazi wenye ujuzi na wasio na ujuzi katika sekta mbalimbali za kilimo.</p>'
            }
        },
        'construction': {
            title: getTranslation('Construction Boom Creates New Jobs'),
            icon: 'fas fa-tools',
            content: {
                en: '<h3>Construction Industry Expansion</h3><p>Kenya\'s construction sector is experiencing unprecedented growth, driven by government infrastructure projects, private development, and urbanization. This boom is creating thousands of new job opportunities in rural and peri-urban areas.</p>',
                sw: '<h3>Upana wa Sekta ya Ujenzi</h3><p>Sekta ya ujenzi ya Kenya inapata ukuaji usio wa kawaida, unaoendeshwa na miradi ya miundombinu ya serikali, maendeleo ya kibinafsi, na ukuzaji wa mijini. Ukuaji huu unaunda maelfu ya fursa mpya za kazi katika maeneo ya vijijini na karibu na mijini.</p>'
            }
        },
        'domestic': {
            title: getTranslation('Domestic Work Opportunities'),
            icon: 'fas fa-home',
            content: {
                en: '<h3>The Domestic Work Sector in Kenya</h3><p>Domestic work remains one of the largest employment sectors in Kenya, providing livelihoods for hundreds of thousands of workers, particularly women from rural areas. The sector is undergoing significant transformation with improved regulations and working conditions.</p>',
                sw: '<h3>Sekta ya Kazi za Nyumbani nchini Kenya</h3><p>Kazi za nyumbani bado ni moja ya sekta kubwa za ajira nchini Kenya, ikitoa riziki kwa mamia ya maelfu ya wafanyakazi, haswa wanawake kutoka maeneo ya vijijini. Sekta inakabiliwa na mabadiliko makubwa kwa sheria bora na hali bora za kufanya kazi.</p>'
            }
        }
    };

    function openBlog(blogId) {
        const blog = blogContent[blogId];
        if (!blog) return;
        
        document.getElementById('blog-modal-title').textContent = blog.title;
        document.getElementById('blog-modal-image').innerHTML = `<i class="${blog.icon}"></i>`;
        document.getElementById('blog-modal-body').innerHTML = blog.content[currentLanguage];
        document.getElementById('blogModal').style.display = 'flex';
    }

    function closeBlogModal() {
        document.getElementById('blogModal').style.display = 'none';
    }

    // Export functions for global access
    window.showSection = showSection;
    window.clearForm = clearForm;
    window.sortJobs = sortJobs;
    window.sortEmployees = sortEmployees;
    window.openBlog = openBlog;
    window.closeBlogModal = closeBlogModal;
    window.openEditModal = openEditModal;
    window.closeEditModal = closeEditModal;
    window.deleteJob = deleteJob;
    window.generateWhatsAppLink = generateWhatsAppLink;
    window.formatPhoneNumber = formatPhoneNumber;
    window.toggleLanguage = toggleLanguage;
    window.translatePage = translatePage;
    window.showAuthModal = showAuthModal;
    window.closeAuthModal = closeAuthModal;
    window.showRoleSelection = showRoleSelection;
    window.showSignUp = showSignUp;
    window.showLogin = showLogin;
    window.selectRole = selectRole;
    window.openProfileModal = openProfileModal;
    window.closeProfileModal = closeProfileModal;
    window.openPasswordModal = openPasswordModal;
    window.closePasswordModal = closePasswordModal;
    window.logout = logout;

    // Initialize the application when DOM is loaded
    document.addEventListener('DOMContentLoaded', initializeApp);
</script>